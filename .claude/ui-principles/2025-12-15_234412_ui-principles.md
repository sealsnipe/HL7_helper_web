# UI Principles for HL7 Helper Web

## Document Information

| Attribute | Value |
|-----------|-------|
| **Version** | 1.0.0 |
| **Created** | 2025-12-15T23:44:12 |
| **Status** | Official Reference |
| **Maintained By** | @ux-analyst |

---

## 1. Global Principles

### 1.1 Layout Standards

- **Container Width**: `max-w-7xl mx-auto` for all main content
- **Header**: Sticky positioning with backdrop blur (`sticky top-0 z-40 backdrop-blur`)
- **Padding**: Consistent `p-6` or `p-8` for main sections
- **Spacing**: Use `space-y-4`, `space-y-6`, `space-y-8` for vertical rhythm

### 1.2 Theming System

**7 Supported Themes:**
1. Light (default)
2. Dark
3. System
4. Forest
5. Ocean
6. Sunset
7. Midnight

**Theme Implementation:**
- Use CSS custom properties: `bg-background`, `text-foreground`, `border-border`
- Theme context provided by `ThemeProvider.tsx`
- Theme switcher accessible via `ThemeSwitcher.tsx` in `NavigationHeader`
- All components MUST support all 7 themes

### 1.3 Typography

| Element | Style |
|---------|-------|
| Page Title (h1) | `text-3xl font-bold` |
| Section Title (h2) | `text-xl font-semibold` |
| Labels | `text-sm font-medium` |
| Body Text | `text-base` (14px minimum) |
| Small Text | `text-sm` |

**Rules:**
- One `<h1>` per page only
- Maintain heading hierarchy (h1 → h2 → h3)
- No skipped heading levels

### 1.4 Animation & Transitions

| Transition | Duration | Use Case |
|------------|----------|----------|
| Primary | `200ms` | Button hovers, focus states, simple interactions |
| Gradient | `500ms` | Background gradients, theme transitions |

**Animation Classes:**
- `transition-all duration-200`
- `transition-colors duration-200`
- Gradients: `transition-all duration-500`

### 1.5 Z-Index System

| Layer | Z-Index | Use Case |
|-------|---------|----------|
| Header | `z-40` | NavigationHeader (sticky) |
| Modals | `z-50` | Dialog overlays |
| Tooltips | (default) | Contextual help |

---

## 2. Shared Components

### 2.1 NavigationHeader

**Required on ALL pages**

**Structure:**
- Logo/brand (links to `/`)
- 4-page navigation:
  - "Editor" (/)
  - "Templates" (/templates)
  - "Create Template" (/templates/create)
  - "Use Template" (/templates/use)
- ThemeSwitcher (right-aligned)

**Behavior:**
- Active page highlighted with accent color
- Sticky positioning
- Responsive: collapses on mobile

**File:** `src/components/NavigationHeader.tsx`

### 2.2 MessageEditor

**Used on 3 pages:**
- Main Editor (/)
- Create Template (/templates/create)
- Use Template (/templates/use)

**Core Features:**
- Segment/field hierarchy display
- Inline field editing via `FieldInput`
- Definition tooltips (when available)
- Expand/collapse segments
- MSH-1 and MSH-2 always read-only

**Key Props:**
- `segments: SegmentDto[]`
- `onChange: (segments: SegmentDto[]) => void`
- `definitionsMap: Record<string, SegmentDefinition>`
- `readOnly?: boolean`
- `editablePositions?: Set<string>` (Use Template only)

**File:** `src/components/MessageEditor.tsx`

### 2.3 FieldInput

**Used within MessageEditor**

**3 Render Modes:**
1. **Simple**: Single text input
2. **Composite**: Multiple component inputs (separator: `^`)
3. **Repetition**: Repeating field groups (separator: `~`)

**States:**
- Editable (white/dark background)
- Read-only (gray background)
- HELPERVARIABLE (colored background based on group)

**File:** `src/components/FieldInput.tsx`

### 2.4 ConfirmDialog

**Used for destructive actions**

**Variants:**
- `default`: Blue accent, general confirmations
- `destructive`: Red accent, delete/remove actions

**Features:**
- Focus trap (Escape to close, Enter to confirm)
- Accessible (ARIA labels, role="dialog")
- Backdrop click to dismiss

**File:** `src/components/dialogs/ConfirmDialog.tsx`

### 2.5 ThemeSwitcher

**7-theme dropdown**

**Location:** NavigationHeader (right side)

**Behavior:**
- Current theme selected by default
- Updates immediately on change
- Persists to localStorage

**File:** `src/components/ThemeSwitcher.tsx`

### 2.6 ErrorBoundary

**Wraps entire application**

**Behavior:**
- Catches React errors
- Shows graceful error UI
- Provides "Try Again" recovery button

**File:** `src/components/ErrorBoundary.tsx`

### 2.7 DataManagement

**Export/Import JSON templates**

**Features:**
- Export all templates to JSON
- Import templates from JSON file
- Validation on import
- Merge strategy (overwrites duplicates)

**Used on:** Template List page (`/templates`)

**File:** `src/components/DataManagement.tsx`

---

## 3. Page Templates

### 3.1 Main Editor (/)

**URL:** `/`

**Unique Features:**
- Textarea input with 300ms debounce parsing
- Output display with gradient border
- "Load from Template" modal (not inline)
- Real-time parse feedback

**Layout:**
```
NavigationHeader
└─ Main Content (max-w-7xl)
   ├─ Heading + Description
   ├─ Input Textarea (HL7 text)
   ├─ MessageEditor (parsed segments)
   ├─ "Load from Template" button → modal
   └─ Generated Output (copy button)
```

**State Management:**
- Does NOT persist to localStorage
- Session-only state

**File:** `src/app/page.tsx`

### 3.2 Template List (/templates)

**URL:** `/templates`

**Unique Features:**
- Expandable template rows
- **Two modes:**
  - **View Mode**: Read-only, HELPERVARIABLE highlighting
  - **Edit Mode**: All fields editable (except MSH-1/2)
- "View Variables Only" toggle (both modes)
- DataManagement (export/import)

**Layout:**
```
NavigationHeader
└─ Main Content (max-w-7xl)
   ├─ Heading + Description
   ├─ DataManagement buttons
   ├─ "View Variables Only" toggle
   └─ Template Cards (expandable)
      ├─ Header (name, description, actions)
      └─ MessageEditor (conditional: view/edit mode)
```

**HELPERVARIABLE Rules:**
- **View Mode**: Highlighted, read-only
- **Edit Mode**: Highlighted, editable

**State Management:**
- Persists to localStorage: `hl7-helper:templates`

**File:** `src/app/templates/page.tsx`

### 3.3 Create Template (/templates/create)

**URL:** `/templates/create`

**Status:** Legacy page (basic functionality)

**Unique Features:**
- Simple form: name, description, HL7 text
- No variable highlighting
- No preview

**Layout:**
```
NavigationHeader
└─ Main Content (max-w-7xl)
   ├─ Heading
   ├─ Form
   │  ├─ Name input
   │  ├─ Description textarea
   │  ├─ HL7 Message textarea
   │  └─ Submit button
   └─ Success/Error messages
```

**State Management:**
- Saves to localStorage: `hl7-helper:templates`

**File:** `src/app/templates/create/page.tsx`

### 3.4 Use Template (/templates/use)

**URL:** `/templates/use`

**Unique Features:**
- Multi-serialization pairs (5 tabs)
- **Variables-only mode** (no toggle - ALWAYS variables-only)
- HELPERVARIABLE highlighting (8-color rotation)
- Position-based editability (not content-based)

**Layout:**
```
NavigationHeader
└─ Main Content (max-w-7xl)
   ├─ Heading + Description
   ├─ Template Selector dropdown
   ├─ MessageEditor (ONLY variable positions editable)
   └─ Serialization Tabs
      ├─ Tab 1-5 (HDHL7, Mirth, etc.)
      └─ Output with copy button
```

**HELPERVARIABLE Rules:**
- **Highlighting**: Yes (8 colors by group)
- **Editability**: ONLY positions that originally contained HELPERVARIABLEs
- **After editing**: Field stays editable even if variable text replaced

**State Management:**
- Does NOT persist user input
- Templates loaded from localStorage

**File:** `src/app/templates/use/page.tsx`

---

## 4. HELPERVARIABLE System

### 4.1 Syntax Rules

**Valid formats:**
- `HELPERVARIABLE` (ungrouped, group = 0)
- `HELPERVARIABLE1` to `HELPERVARIABLE999` (grouped)

**Case-sensitive:** Must be uppercase

### 4.2 Color Rotation

**8 Colors by Group Number:**

| Group | Color | Tailwind Class |
|-------|-------|----------------|
| 0 (ungrouped) | Indigo | `bg-indigo-100/50 dark:bg-indigo-900/50` |
| 1, 9, 17... | Blue | `bg-blue-100/50 dark:bg-blue-900/50` |
| 2, 10, 18... | Green | `bg-green-100/50 dark:bg-green-900/50` |
| 3, 11, 19... | Yellow | `bg-yellow-100/50 dark:bg-yellow-900/50` |
| 4, 12, 20... | Red | `bg-red-100/50 dark:bg-red-900/50` |
| 5, 13, 21... | Purple | `bg-purple-100/50 dark:bg-purple-900/50` |
| 6, 14, 22... | Pink | `bg-pink-100/50 dark:bg-pink-900/50` |
| 7, 15, 23... | Orange | `bg-orange-100/50 dark:bg-orange-900/50` |
| 8, 16, 24... | Teal | `bg-teal-100/50 dark:bg-teal-900/50` |

**Formula:** `color_index = (group_number - 1) % 8`

### 4.3 Editability Rules (Use Template Page)

**Position-based, NOT content-based:**

1. Parse template → identify positions containing HELPERVARIABLEs
2. Store positions in `editablePositions: Set<string>` (format: `"SEG-fieldIndex-componentIndex"`)
3. Field is editable IF its position is in the set
4. User edits field → content changes, but position remains editable
5. Field STAYS editable even after variable replaced with real data

**Example:**
```
Original: PID-5.1 = "HELPERVARIABLE1"
User edits: PID-5.1 = "John"
Result: PID-5.1 remains editable (color stays, editability persists)
```

### 4.4 Page-Specific Behavior

| Page | Highlighting | Editability |
|------|--------------|-------------|
| Main Editor (/) | ❌ No | All fields (except MSH-1/2) |
| Template List (view mode) | ✅ Yes | ❌ Read-only |
| Template List (edit mode) | ✅ Yes | All fields (except MSH-1/2) |
| Use Template | ✅ Yes | Only variable positions |

### 4.5 Linked Variables (Prepared, Not Active)

**Current State:** Infrastructure exists but NOT connected

**Prepared Features:**
- Group badge displayed on fields
- Props passed to components
- No actual linking behavior implemented

**Location:** `FieldInput.tsx` (badge display), `MessageEditor.tsx` (props)

---

## 5. Known Deviations

### 5.1 Inconsistent Patterns

| Pattern | Inconsistency | Locations |
|---------|---------------|-----------|
| **Destructive buttons** | 3 different styles | Template list, dialogs, forms |
| **Error banners** | Amber vs. Red backgrounds | Various pages |
| **Loading spinners** | 2 different implementations | Async operations |
| **localStorage keys** | Inconsistent prefixing | `hl7-helper:templates` vs `generated_hl7` |

**Status:** Documented, not blocking. Future harmonization recommended.

### 5.2 Missing Patterns

| Pattern | Current State | Impact |
|---------|---------------|--------|
| **Tooltips** | Only 2 uses across codebase | Low discoverability |
| **Keyboard shortcuts** | None implemented | Power-user workflow |
| **Auto-save** | No auto-save anywhere | Data loss risk |
| **Unsaved changes warning** | Not implemented | User confusion |

**Status:** Known gaps, prioritized for future work.

### 5.3 Technical Constraints

**No fallbacks for modern APIs:**
- `crypto.randomUUID()` (no IE11 support)
- `structuredClone()` (no Safari <15.4)
- `navigator.clipboard` (requires HTTPS)

**Status:** Acceptable for target audience (modern browsers).

---

## 6. Component Standards

### 6.1 Button Standards

**Variants:**
- **Primary:** `bg-primary text-primary-foreground hover:bg-primary/90`
- **Destructive:** `bg-destructive text-destructive-foreground hover:bg-destructive/90`
- **Ghost:** `hover:bg-accent hover:text-accent-foreground`

**States:**
- `:hover` - Slight opacity change (`/90`)
- `:focus-visible` - Ring (`ring-2 ring-ring ring-offset-2`)
- `:disabled` - `opacity-50 cursor-not-allowed`

### 6.2 Input Standards

**Text Inputs:**
```tsx
<input
  className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
/>
```

**Textareas:**
- Same styling as input, but `min-h-20`

**HELPERVARIABLE styling:**
- Applied via FieldInput component
- Dynamic background color based on group

### 6.3 Card Standards

**Standard Card:**
```tsx
<div className="rounded-lg border bg-card text-card-foreground shadow-sm">
  <div className="p-6">
    {/* Content */}
  </div>
</div>
```

**Template Card (expandable):**
- Header always visible
- Expandable content with animation
- Actions (edit, delete, duplicate) in header

### 6.4 Loading States

**Spinner:**
```tsx
<div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
```

**Skeleton Loaders:** Not currently implemented (future consideration)

### 6.5 Error States

**Error Banner:**
```tsx
<div className="rounded-md bg-destructive/15 p-4">
  <p className="text-sm text-destructive">{errorMessage}</p>
</div>
```

**Inline Validation:** Not standardized (varies by form)

---

## 7. New Page Checklist

When a new page is detected by the page-coverage E2E test, verify:

### 7.1 Required Elements

- [ ] **NavigationHeader** present and functional
- [ ] **Theme support** - all 7 themes render correctly
- [ ] **Responsive** - tested at 4 viewports (Desktop, Laptop, Tablet, Mobile)
- [ ] **Heading hierarchy** - single h1, proper nesting
- [ ] **Max-width container** - `max-w-7xl mx-auto` for main content

### 7.2 Accessibility

- [ ] **Keyboard navigation** - all interactive elements reachable
- [ ] **Focus states** - visible focus indicators
- [ ] **ARIA labels** - for icons, non-text controls
- [ ] **Color contrast** - minimum 4.5:1 for text
- [ ] **Skip links** - if long navigation

### 7.3 States

- [ ] **Loading states** - for async operations
- [ ] **Error states** - user-friendly messages with recovery
- [ ] **Empty states** - meaningful messages with CTAs
- [ ] **Success states** - confirmation for actions

### 7.4 Forms (if applicable)

- [ ] **Labels** - all inputs have associated labels
- [ ] **Validation** - inline feedback before submission
- [ ] **Submit/Cancel** - clear actions
- [ ] **Disabled states** - during submission

### 7.5 Data Persistence (if applicable)

- [ ] **localStorage keys** - use `hl7-helper:` prefix
- [ ] **Session vs. persistence** - documented decision
- [ ] **Migration strategy** - if changing data structure

### 7.6 HELPERVARIABLE Support (if using MessageEditor)

- [ ] **Highlighting** - 8-color rotation correct
- [ ] **Editability** - position-based rules enforced
- [ ] **Theme support** - colors work in all themes

---

## 8. Future Improvements

### 8.1 Mobile Optimization

**Current Issues:**
- Fixed heights don't adapt to small screens
- No touch-optimized interactions
- Horizontal scrolling on some components

**Recommendation:** Future mobile-first redesign

### 8.2 Auto-Save

**Current State:** No auto-save anywhere

**Recommendation:**
- Debounced auto-save to localStorage
- "Unsaved changes" warning on navigation
- Visual indicator of save status

### 8.3 Tooltips & Help

**Current State:** Very limited (2 uses)

**Recommendation:**
- Consistent tooltip component
- Field-level help for complex inputs
- Onboarding hints for new users

### 8.4 Keyboard Shortcuts

**Current State:** None

**Recommendation:**
- `Ctrl+S` - Save/Generate
- `Ctrl+K` - Command palette
- `Esc` - Close modals/clear focus

### 8.5 ORM^O01 Definition

**Current State:** Definition exists in code but NOT in dropdown

**Recommendation:** Add to message type dropdown or document exclusion reason

---

## 9. Technical Details

### 9.1 Browser API Dependencies

| API | Usage | Fallback |
|-----|-------|----------|
| `crypto.randomUUID()` | Template IDs | ❌ None |
| `structuredClone()` | Deep cloning | ❌ None |
| `navigator.clipboard` | Copy to clipboard | ❌ Silent fail |

**Minimum Browser Versions:**
- Chrome 92+
- Firefox 90+
- Safari 15.4+

### 9.2 localStorage Schema

| Key | Data Type | Purpose |
|-----|-----------|---------|
| `hl7-helper:templates` | `Array<Template>` | User templates |
| `hl7-helper:migrations` | `{ version: string }` | Migration tracking |
| `generated_hl7` | `string` | Last generated HL7 (unprefixed!) |
| `hl7-helper-theme` | `string` | Selected theme |

### 9.3 Type Definitions

**Core Types:** `src/types/index.ts`

```typescript
interface SegmentDto {
  id: string;
  name: string;
  fields: FieldDto[];
}

interface FieldDto {
  id: string;
  value: string;
  components?: ComponentDto[];
  repetitions?: ComponentDto[][];
}

interface ComponentDto {
  id: string;
  value: string;
}

interface Template {
  id: string;
  name: string;
  description: string;
  messageType: string;
  segments: SegmentDto[];
  createdAt: string;
}
```

---

## 10. Serialization System (Prepared, Not Active)

### 10.1 Current State

**9 Serialization Components Exist:**

| Component | Purpose | Status |
|-----------|---------|--------|
| `DefaultSerializer` | Base implementation | ✅ Complete |
| `HDSerializationPair` | HD HL7 format | ✅ Complete |
| `MirthSerializationPair` | Mirth Connect | ✅ Complete |
| `Hl7v2SerializationPair` | Standard HL7v2 | ✅ Complete |
| `XmlSerializationPair` | XML format | ✅ Complete |
| `JsonSerializationPair` | JSON format | ✅ Complete |

**Location:** `src/components/serialization/`

**Active Code Path:** Uses simpler inline serialization in `use/page.tsx`

**Recommendation:** Future refactor to use prepared components

### 10.2 Dead Code

**Functions Not in Active Path:**
- `filterSegmentsForVariables()` - Replaced by position-based approach
- `extractUniqueVariables()` - Not used in current flow

**Recommendation:** Remove or document if truly unused

---

## 11. Update Instructions

### 11.1 When to Update This Document

- New page added to application
- New shared component created
- HELPERVARIABLE system changes
- Global layout/theme changes
- New UI pattern established

### 11.2 How to Update

1. **Create new timestamped file:**
   ```
   .claude/ui-principles/YYYY-MM-DD_HHMMSS_ui-principles.md
   ```
   Use current timestamp to the second.

2. **Copy content from previous version** (this file)

3. **Make changes:**
   - Add new sections
   - Update existing principles
   - Document new deviations
   - Update version number (semantic versioning)

4. **Update document header:**
   ```markdown
   | **Version** | X.Y.Z |
   | **Created** | YYYY-MM-DDTHH:MM:SS |
   ```

5. **Commit new file** (do NOT delete old versions - they serve as history)

6. **Update reference in tests:**
   - `tests/e2e/page-coverage.spec.ts` - update expected path if needed

### 11.3 Responsibilities

| Role | Responsibility |
|------|----------------|
| **@ux-analyst** | Maintain document, verify compliance, add new principles |
| **@ux-designer** | Identify patterns, suggest improvements, flag inconsistencies |
| **@developer** | Implement to principles, flag deviations with justification |
| **@reviewer** | Verify principle compliance in code reviews |

---

## 12. Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2025-12-15 | Initial official UI principles document |

---

**Document End**

This document is the authoritative reference for UI consistency in the HL7 Helper Web project. When in doubt, consult this document. If a pattern is not documented here, it should be added by @ux-analyst before becoming standard practice.
